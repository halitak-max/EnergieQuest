name: Deploy to Hetzner (FTP)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, intl, gd, xml, curl

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Composer Dependencies (Production)
      run: composer install --no-dev --optimize-autoloader --prefer-dist

    - name: Build Frontend Assets
      run: |
        npm ci
        npm run build

    - name: Prepare and Zip Artifacts
      run: |
        # Struktur vorbereiten
        mkdir -p deployment/energiequest
        mkdir -p deployment/public_html

        # Core kopieren
        rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='deployment' --exclude='public' ./ deployment/energiequest/
        
        # Public kopieren
        cp -r public/. deployment/public_html/

        # Index.php anpassen
        sed -i "s|/../vendor/autoload.php|/../energiequest/vendor/autoload.php|g" deployment/public_html/index.php
        sed -i "s|/../bootstrap/app.php|/../energiequest/bootstrap/app.php|g" deployment/public_html/index.php
        sed -i "s|/../storage/framework/maintenance.php|/../energiequest/storage/framework/maintenance.php|g" deployment/public_html/index.php
        sed -i "/bootstrap\/app.php';/a \$app->usePublicPath(__DIR__);" deployment/public_html/index.php

        # ZIPPEN
        # Core Zip
        cd deployment/energiequest
        zip -r ../../core.zip .
        cd ../..

        # Public Zip
        cd deployment/public_html
        zip -r ../../public.zip .
        cd ../..

        # Unzip-Script erstellen (Lädt Zips, entpackt sie und führt Tasks aus)
        cat <<EOF > deployment/unzip_and_migrate.php
        <?php
        \$secretKey = '${{ secrets.DEPLOY_KEY }}';
        if (!isset(\$_GET['key']) || \$_GET['key'] !== \$secretKey) {
            http_response_code(403);
            die('Access denied.');
        }

        echo "<h1>Deployment Log</h1><pre>";

        function unzip(\$file, \$path) {
            if (!file_exists(\$file)) {
                echo "File \$file not found, skipping.\\n";
                return;
            }
            echo "Unzipping \$file to \$path... ";
            \$zip = new ZipArchive;
            if (\$zip->open(\$file) === TRUE) {
                if (!is_dir(\$path)) mkdir(\$path, 0755, true);
                \$zip->extractTo(\$path);
                \$zip->close();
                echo "OK.\\n";
                unlink(\$file); // Zip löschen
                echo "Zip deleted.\\n";
            } else {
                echo "FAILED.\\n";
            }
        }

        // 1. Unzip Core (liegt eine Ebene höher, also ../energiequest)
        // Wir gehen davon aus, dass wir im public_html Root sind
        
        unzip(__DIR__ . '/core.zip', __DIR__ . '/../energiequest');
        unzip(__DIR__ . '/public.zip', __DIR__);

        // 2. Laravel Tasks
        require __DIR__ . '/../energiequest/vendor/autoload.php';
        \$app = require_once __DIR__ . '/../energiequest/bootstrap/app.php';
        \$kernel = \$app->make(Illuminate\Contracts\Http\Kernel::class);
        \$response = \$kernel->handle(\$request = Illuminate\Http\Request::capture());

        echo "\\n--- Artisan Tasks ---\\n";
        
        function run(\$cmd) {
            try {
                echo "Running: \$cmd\\n";
                \Illuminate\Support\Facades\Artisan::call(\$cmd);
                echo \Illuminate\Support\Facades\Artisan::output() . "\\n";
            } catch (\Exception \$e) {
                echo "Error: " . \$e->getMessage() . "\\n";
            }
        }
        
        // Storage Link
        if (!file_exists(__DIR__ . '/storage')) {
           symlink(__DIR__ . '/../energiequest/storage/app/public', __DIR__ . '/storage');
           echo "Storage linked.\\n";
        }
        
        run('migrate --force');
        run('config:cache');
        run('route:cache');
        run('view:cache');
        
        echo "\\nDeployment finished successfully.</pre>";
        EOF

    - name: Install LFTP and Zip
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp zip

    - name: Upload Zips and Script via LFTP
      run: |
        # Wir laden die Zips in das Root (oder public_html) und das Script explizit nach public_html
        # Damit es per Browser aufrufbar ist.
        # Annahme: Web-Root ist /public_html/
        lftp -e "set ftp:ssl-auth TLS; set ftp:ssl-force true; set ssl:verify-certificate no; put core.zip; put public.zip; put -O /public_html/ deployment/unzip_and_migrate.php; bye" -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_SERVER }}

    - name: Trigger Unzip and Migration
      run: |
        # Timeout erhöht (300s), da Entpacken dauern kann. -L folgt Redirects.
        echo "Triggering deployment script..."
        curl -s -L --max-time 300 --retry 3 "https://energiequest.de/unzip_and_migrate.php?key=${{ secrets.DEPLOY_KEY }}"
