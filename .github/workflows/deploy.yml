name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-prod
  cancel-in-progress: false

env:
  APP_PATH: ${{ secrets.APP_PATH }} # e.g. /var/www/energiequest
  NODE_VERSION: "18"
  PHP_VERSION: "8.2"
  SSH_PORT: ${{ secrets.SSH_PORT }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          coverage: none

      - name: Install PHP dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install JS dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Trim build artifacts
        run: |
          rm -rf node_modules tests .git .github

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          PORT=${SSH_PORT:-22}
          ssh-keyscan -p "$PORT" -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        env:
          SSH_PORT: ${{ env.SSH_PORT }}
          SSH_HOST: ${{ secrets.SSH_HOST }}

      - name: Rsync to server
        run: |
          PORT=${SSH_PORT:-22}
          RSYNC_RSH="sshpass -p '${SSH_PASSWORD}' ssh -p ${PORT} -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no"
          rsync -az --delete -e "${RSYNC_RSH}" \
            --exclude=".env" \
            --exclude="storage/app/**" \
            --exclude="storage/logs/**" \
            --exclude="storage/framework/cache/**" \
            --exclude="storage/framework/sessions/**" \
            --exclude="storage/framework/testing/**" \
            --exclude=".git" \
            ${GITHUB_WORKSPACE}/ ${SSH_USER}@${SSH_HOST}:${APP_PATH}/
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}

      - name: Run remote deploy steps
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ env.SSH_PORT }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          PHP_FPM_SERVICE: ${{ secrets.PHP_FPM_SERVICE }}
        run: |
          PORT=${SSH_PORT:-22}
          sshpass -p "${SSH_PASSWORD}" ssh -p ${PORT} -o StrictHostKeyChecking=no -o PreferredAuthentications=password -o PubkeyAuthentication=no ${SSH_USER}@${SSH_HOST} <<'EOF'
          set -e
          cd ${APP_PATH}

          # Ensure permissions for cache/bootstrap
          chown -R ${USER}:www-data storage bootstrap/cache
          find storage bootstrap/cache -type d -exec chmod 775 {} \;

          # Laravel tasks
          php artisan migrate --force
          php artisan optimize
          php artisan queue:restart || true

          # Reload services
          if [ -n "${PHP_FPM_SERVICE}" ]; then
            sudo systemctl reload "${PHP_FPM_SERVICE}" || true
          fi
          sudo systemctl reload nginx || true
          EOF

