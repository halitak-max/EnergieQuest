name: Deploy to Hetzner (FTP)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, intl, gd, xml, curl

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Composer Dependencies (Production)
      run: composer install --no-dev --optimize-autoloader --prefer-dist

    - name: Build Frontend Assets
      run: |
        npm ci
        npm run build

    - name: Prepare Deployment Structure
      run: |
        # Erstelle temporären Ordner für den Upload
        mkdir -p deployment/energiequest
        mkdir -p deployment/public_html

        # 1. Kopiere das gesamte Projekt (außer public) nach deployment/energiequest
        rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='deployment' --exclude='public' ./ deployment/energiequest/

        # 2. Kopiere den Inhalt von public nach deployment/public_html
        # Das entspricht dem Wunsch: public Inhalt in public_html kopieren
        cp -r public/. deployment/public_html/

        # 3. Passe index.php an
        # Pfade zeigen jetzt auf ../energiequest (da public_html und energiequest auf gleicher Ebene liegen)
        sed -i "s|/../vendor/autoload.php|/../energiequest/vendor/autoload.php|g" deployment/public_html/index.php
        sed -i "s|/../bootstrap/app.php|/../energiequest/bootstrap/app.php|g" deployment/public_html/index.php
        sed -i "s|/../storage/framework/maintenance.php|/../energiequest/storage/framework/maintenance.php|g" deployment/public_html/index.php
        
        # Setze Public Path Fix
        sed -i "/bootstrap\/app.php';/a \$app->usePublicPath(__DIR__);" deployment/public_html/index.php

        # 4. Erstelle deploy-tasks.php on-the-fly (für Migrationen ohne SSH)
        # Wir erstellen die Datei direkt hier, damit sie nicht im Repo liegen muss.
        cat <<EOF > deployment/public_html/deploy-tasks.php
        <?php
        \$secretKey = '${{ secrets.DEPLOY_KEY }}';
        if (!isset(\$_GET['key']) || \$_GET['key'] !== \$secretKey) {
            http_response_code(403);
            die('Access denied.');
        }
        require __DIR__ . '/../energiequest/vendor/autoload.php';
        \$app = require_once __DIR__ . '/../energiequest/bootstrap/app.php';
        \$kernel = \$app->make(Illuminate\Contracts\Http\Kernel::class);
        \$response = \$kernel->handle(\$request = Illuminate\Http\Request::capture());
        
        echo "<h1>Tasks</h1>";
        function run(\$cmd) {
            try {
                echo "Running: \$cmd<br>";
                \Illuminate\Support\Facades\Artisan::call(\$cmd);
                echo "<pre>" . \Illuminate\Support\Facades\Artisan::output() . "</pre><hr>";
            } catch (\Exception \$e) {
                echo "<div style='color:red'>Error: " . \$e->getMessage() . "</div><hr>";
            }
        }
        
        // Storage Link (wichtig: manuell, da artisan link oft relative pfade falsch macht)
        if (!file_exists(__DIR__ . '/storage')) {
           symlink(__DIR__ . '/../energiequest/storage/app/public', __DIR__ . '/storage');
           echo "Storage linked.<hr>";
        }
        
        run('migrate --force');
        run('config:cache');
        run('route:cache');
        run('view:cache');
        echo "Done.";
        EOF

    - name: Deploy Core to energiequest folder
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftps
        ignore-data-protection: true
        local-dir: ./deployment/energiequest/
        server-dir: /energiequest/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/storage/*.key

    - name: Deploy Public to public_html folder
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftps
        ignore-data-protection: true
        local-dir: ./deployment/public_html/
        server-dir: /public_html/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/storage/*.key

    - name: Trigger Post-Deployment Tasks
      run: |
        curl -s -f --retry 3 "https://laravel.energiequest.de/deploy-tasks.php?key=${{ secrets.DEPLOY_KEY }}"
